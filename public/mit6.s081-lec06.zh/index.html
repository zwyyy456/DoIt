

<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" /><title>MIT 6.S081 Isolation &amp; System call entry/exit - DoIt</title><meta name="Description" content="The official documentation for the Hugo DoIt theme"><meta property="og:url" content="http://localhost:1313/mit6.s081-lec06.zh/">
  <meta property="og:site_name" content="DoIt">
  <meta property="og:title" content="MIT 6.S081 Isolation &amp; System call entry/exit">
  <meta property="og:description" content="1 Trap 机制程序运行往往需要完成用户空间和内核空间的切换，每当：
程序执行系统调用（system call）； 程序出现了 page fault 等错误； 一个设备触发了中断； 都会发生这样的切换。
这里用户空间切换到内核空间通常被称为 trap，因此有时候我们会说程序“陷入”到内核态。trap 机制需要尽可能的简单。
trap 的工作，可以说是让硬件从适合运行用户程序的状态，切换到适合运行内核代码的状态。
这里说的状态中，我们最关心的状态可能是 $32$ 个用户寄存器，我们尤其需要关注以下硬件寄存器的内容：
堆栈寄存器（stack register，又称 stack pointer）； 程序计数器（Program Counter Register）； 表明当前 mode 的标志位的寄存器，表明当前是 supervisor mode 还是 user mode； 控制 CPU 工作方式的寄存器，例如 SATP（Supervisor Address Translation and Protection）寄存器，它包含了指向 page table 的物理内存地址； STVEC（Supervisor Trap Vector Base Address Register）寄存器，它指向了内核中处理 trap 的指令的起始地址； SEPC（Supervisor Exception Program Counter）寄存器，在 trap 的过程中保存程序计数器的值； sscratch（Supervisor Scratch Register）寄存器； 在 trap 的最开始，CPU 所有的状态肯定还是在运行用户代码而不是内核代码，在 trap 处理的过程中，我们会逐渐更改状态，或者对状态做一些操作，我们可以设想一下我们需要做哪些操作：
保存 $32$ 个用户寄存器的状态，例如，当响应中断完成后，我们会希望能恢复用户程序的执行，而这些寄存器需要被内核代码所使用，因此，在 trap 之前，我们需要保存这 $32$ 个用户寄存器的内容； 保存 PC 的内容，原因类似于保存 $32$ 个用户寄存器； 将 mode 修改为 supervisor mode； 运行内核代码前，将 SATP 由指向 user page table 修改为指向 kernel page table； trap 机制不会依赖于 $32$ 个用户寄存器；">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-08T15:32:43+08:00">
    <meta property="article:modified_time" content="2023-07-08T15:32:43+08:00">
    <meta property="article:tag" content="Xv6">
    <meta property="article:tag" content="Mit">
    <meta property="article:tag" content="Os">
    <meta property="og:image" content="http://localhost:1313/images/avatar.webp">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/images/avatar.webp">
  <meta name="twitter:title" content="MIT 6.S081 Isolation &amp; System call entry/exit">
  <meta name="twitter:description" content="1 Trap 机制程序运行往往需要完成用户空间和内核空间的切换，每当：
程序执行系统调用（system call）； 程序出现了 page fault 等错误； 一个设备触发了中断； 都会发生这样的切换。
这里用户空间切换到内核空间通常被称为 trap，因此有时候我们会说程序“陷入”到内核态。trap 机制需要尽可能的简单。
trap 的工作，可以说是让硬件从适合运行用户程序的状态，切换到适合运行内核代码的状态。
这里说的状态中，我们最关心的状态可能是 $32$ 个用户寄存器，我们尤其需要关注以下硬件寄存器的内容：
堆栈寄存器（stack register，又称 stack pointer）； 程序计数器（Program Counter Register）； 表明当前 mode 的标志位的寄存器，表明当前是 supervisor mode 还是 user mode； 控制 CPU 工作方式的寄存器，例如 SATP（Supervisor Address Translation and Protection）寄存器，它包含了指向 page table 的物理内存地址； STVEC（Supervisor Trap Vector Base Address Register）寄存器，它指向了内核中处理 trap 的指令的起始地址； SEPC（Supervisor Exception Program Counter）寄存器，在 trap 的过程中保存程序计数器的值； sscratch（Supervisor Scratch Register）寄存器； 在 trap 的最开始，CPU 所有的状态肯定还是在运行用户代码而不是内核代码，在 trap 处理的过程中，我们会逐渐更改状态，或者对状态做一些操作，我们可以设想一下我们需要做哪些操作：
保存 $32$ 个用户寄存器的状态，例如，当响应中断完成后，我们会希望能恢复用户程序的执行，而这些寄存器需要被内核代码所使用，因此，在 trap 之前，我们需要保存这 $32$ 个用户寄存器的内容； 保存 PC 的内容，原因类似于保存 $32$ 个用户寄存器； 将 mode 修改为 supervisor mode； 运行内核代码前，将 SATP 由指向 user page table 修改为指向 kernel page table； trap 机制不会依赖于 $32$ 个用户寄存器；">
      <meta name="twitter:site" content="@xxxx">
<meta name="application-name" content="DoIt">
<meta name="apple-mobile-web-app-title" content="DoIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><meta name="twitter:creator" content="@xxxx" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<link rel="canonical" href="http://localhost:1313/mit6.s081-lec06.zh/" /><link rel="prev" href="http://localhost:1313/mit6.s081-page-table.zh/" /><link rel="next" href="http://localhost:1313/xv6-lab4.zh/" />
<link rel="stylesheet" href="/css/main.min.css"><link rel="stylesheet" href="/css/style.min.css"><meta name="google-site-verification" content="MQ8DNu27ayX6B_4ObiEDK09vGr1fdy7kOAnbd09hJk4" /><script type="application/ld+json">{"@context": "https://schema.org","@type": "BlogPosting",
        "headline": "MIT 6.S081 Isolation \u0026 System call entry/exit",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http://localhost:1313/mit6.s081-lec06.zh/"
        },"image": ["http://localhost:1313/images/Apple-Devices-Preview.png"],"genre": "posts","keywords":["xv6","mit","os"],"wordcount":  857 ,
        "url": "http://localhost:1313/mit6.s081-lec06.zh/","datePublished": "2023-07-08T15:32:43+08:00","dateModified": "2023-07-08T15:32:43+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "http://localhost:1313/images/avatar.webp",
                    "width":  400 ,
                    "height":  400 
                }},"author": [{
                        "@type": "Person",
                        "name": "zwyyy456",
                        "url": "http://localhost:1313/authors/zwyyy456"
                    }],"description": ""
    }</script></head>


<body data-instant-intensity="viewport" ><script type="text/javascript">
        function setTheme(theme) {
          document.body.setAttribute('theme', theme); 
          document.documentElement.className = theme;
          document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');
          if (theme === 'light') {
            document.documentElement.classList.remove('tw-dark')
          } else {
            document.documentElement.classList.add('tw-dark')
          }
          window.theme = theme;   
          window.isDark = window.theme !== 'light' 
        }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {
            let theme = localStorage.getItem('theme');
            if (theme === 'light' || theme === 'dark') {
            setTheme(theme);
            } else {
                if ((window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    setTheme('dark');
                } else {
                    setTheme('light');
                }
            }
         } else { 
            if ('auto' === 'light' || 'auto' === 'dark') 
                setTheme('auto'), saveTheme('auto'); 
            else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');
        }
        let metaColors = {'light': '#f8f8f8','dark': '#161b22'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop print:!tw-hidden" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="DoIt"><span class="tw-mr-1"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg></span>DoIt</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item"
                    href="/posts/" > Posts </a><a class="menu-item"
                    href="/tags/" > Tags </a><a class="menu-item"
                    href="/categories/" > Categories </a><a class="menu-item"
                    href="/series/" > Series </a><a class="menu-item"
                    href="/authors/" > Authors </a><a class="menu-item"
                    href="/showcase/" > Showcase </a><a class="menu-item"
                    href="/categories/documentation/" > Docs </a><a class="menu-item"
                    href="/about/" > About </a><a class="menu-item"
                    href="https://github.com/HEIGE-PCloud/DoIt"  title="GitHub" 
                    rel="noopener noreferrer" target="_blank" ><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d='M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z'/></svg>  </a><span class="menu-item delimiter"></span><button class="menu-item language" aria-label="Select Language">English<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                    <select class="language-select" aria-label="Select Language" id="language-select-desktop"
                        onchange="location = this.value;"><option value="/mit6.s081-lec06.zh/"  selected>English</option></select>
                </button><span class="menu-item search" id="search-desktop">
                    <input type="text"
                        placeholder="Search titles or contents..."
                        id="search-input-desktop">
                    <button class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
                    </button>
                    <button class="search-button search-clear" id="search-clear-desktop" title="Clear">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"/></svg>
                    </button>
                    <span class="search-button search-loading tw-animate-spin" id="search-loading-desktop">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49 0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156 0c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
                    </span>
                </span><button class="menu-item theme-select" aria-label="Switch Theme">
                    <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
                    <select class="color-theme-select" id="theme-select-desktop" aria-label="Switch Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto</option>
                    </select>
                </button></div>
        </div>
    </div>
</header><header class="mobile print:!tw-hidden" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="DoIt"><span class="tw-mr-1"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg></span>DoIt</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                <div class="search mobile" id="search-mobile">
                    <input type="text"
                        placeholder="Search titles or contents..."
                        id="search-input-mobile">
                    <button class="search-button search-toggle tw-h-10" id="search-toggle-mobile" title="Search">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
                    </button>
                    <button class="search-button search-clear" id="search-clear-mobile" title="Clear">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"/></svg>
                    </button>
                    <span class="search-button search-loading tw-animate-spin" id="search-loading-mobile">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49 0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156 0c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
                    </span>
                </div>
                <button class="search-cancel" id="search-cancel-mobile">
                    Cancel
                </button>
            </div><a class="menu-item" href="/posts/" title="" >Posts</a><a class="menu-item" href="/tags/" title="" >Tags</a><a class="menu-item" href="/categories/" title="" >Categories</a><a class="menu-item" href="/series/" title="" >Series</a><a class="menu-item" href="/authors/" title="" >Authors</a><a class="menu-item" href="/showcase/" title="" >Showcase</a><a class="menu-item" href="/categories/documentation/" title="" >Docs</a><a class="menu-item" href="/about/" title="" >About</a><a class="menu-item" href="https://github.com/HEIGE-PCloud/DoIt" title="GitHub" 
                rel="noopener noreferrer" target="_blank" ><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d='M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z'/></svg></a><button class="menu-item theme-select tw-w-full" aria-label="Switch Theme">
                <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
                <select class="color-theme-select" id="theme-select-mobile" aria-label="Switch Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="auto">Auto</option>
                </select>
            </button><button class="menu-item tw-w-full" title="">English<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                <select class="language-select" title="" onchange="location = this.value;"><option value="/mit6.s081-lec06.zh/"  selected>English</option></select>
            </button></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
            <div class="container"><div class="toc print:!tw-hidden" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#trap-机制">Trap 机制</a></li>
    <li><a href="#ecall-指令"><code>ecall</code> 指令</a></li>
    <li><a href="#ecall-指令执行完之后"><code>ecall</code> 指令执行完之后</a></li>
    <li><a href="#uservec-函数-与-trampoline-page"><code>uservec</code> 函数 与 trampoline page</a></li>
    <li><a href="#usertrap-函数"><code>usertrap</code> 函数</a></li>
    <li><a href="#usertrapret-函数"><code>usertrapret</code> 函数</a></li>
    <li><a href="#userret-函数"><code>userret</code> 函数</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single print:!tw-w-full print:!tw-max-w-none print:!tw-m-0 print:!tw-p-0"><h1 class="single-title">MIT 6.S081 Isolation &amp; System call entry/exit</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'>
        <span class='screen-reader-text'>  </span><a href='http://localhost:1313/authors/zwyyy456'>zwyyy456</a></span>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/notes/"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>Notes</a></span></div>
            <div class="post-meta-line"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;<time datetime="2023-07-08">2023-07-08</time>&nbsp;<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>&nbsp;<time datetime="2023-07-08">2023-07-08</time>&nbsp;<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;857 words&nbsp;<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;5 minutes&nbsp;</div>
        </div><div class="details toc print:!tw-block" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span class="details-icon"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#trap-机制">Trap 机制</a></li>
    <li><a href="#ecall-指令"><code>ecall</code> 指令</a></li>
    <li><a href="#ecall-指令执行完之后"><code>ecall</code> 指令执行完之后</a></li>
    <li><a href="#uservec-函数-与-trampoline-page"><code>uservec</code> 函数 与 trampoline page</a></li>
    <li><a href="#usertrap-函数"><code>usertrap</code> 函数</a></li>
    <li><a href="#usertrapret-函数"><code>usertrapret</code> 函数</a></li>
    <li><a href="#userret-函数"><code>userret</code> 函数</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="trap-机制" class="headerLink">
    <a href="#trap-%e6%9c%ba%e5%88%b6" class="header-mark" aria-label="Header mark for 'Trap 机制'"></a>1 Trap 机制</h2><p>程序运行往往需要完成用户空间和内核空间的切换，每当：</p>
<ul>
<li>程序执行系统调用（system call）；</li>
<li>程序出现了 page fault 等错误；</li>
<li>一个设备触发了中断；</li>
</ul>
<p>都会发生这样的切换。</p>
<p>这里用户空间切换到内核空间通常被称为 trap，因此有时候我们会说程序“陷入”到内核态。trap 机制需要尽可能的简单。</p>
<p>trap 的工作，可以说是让硬件从适合运行用户程序的状态，切换到适合运行内核代码的状态。</p>
<p>这里说的<strong>状态</strong>中，我们最关心的状态可能是 $32$ 个用户寄存器，我们尤其需要关注以下硬件寄存器的内容：</p>
<ul>
<li>堆栈寄存器（stack register，又称 stack pointer）；</li>
<li>程序计数器（Program Counter Register）；</li>
<li>表明当前 mode 的标志位的寄存器，表明当前是 supervisor mode 还是 user mode；</li>
<li>控制 CPU 工作方式的寄存器，例如 SATP（Supervisor Address Translation and Protection）寄存器，它包含了指向 page table 的物理内存地址；</li>
<li>STVEC（Supervisor Trap Vector Base Address Register）寄存器，它指向了内核中处理 trap 的指令的起始地址；</li>
<li>SEPC（Supervisor Exception Program Counter）寄存器，在 trap 的过程中保存程序计数器的值；</li>
<li>sscratch（Supervisor Scratch Register）寄存器；</li>
</ul>
<p>在 trap 的最开始，CPU 所有的状态肯定还是在运行用户代码而不是内核代码，在 trap 处理的过程中，我们会逐渐更改状态，或者对状态做一些操作，我们可以设想一下我们需要做哪些操作：</p>
<ul>
<li>保存 $32$ 个用户寄存器的状态，例如，当响应中断完成后，我们会希望能恢复用户程序的执行，而这些寄存器需要被内核代码所使用，因此，在 trap 之前，我们需要保存这 $32$ 个用户寄存器的内容；</li>
<li>保存 PC 的内容，原因类似于保存 $32$ 个用户寄存器；</li>
<li>将 mode 修改为 supervisor mode；</li>
<li>运行内核代码前，将 SATP 由指向 user page table 修改为指向 kernel page table；</li>
</ul>
<p>trap 机制不会依赖于 $32$ 个用户寄存器；</p>
<p>supervisor mode 可以实现什么 user mode 不能实现的事情？（其实不多）</p>
<ul>
<li>读写 SATP、STVEC、SEPC、sscratch 等寄存器；</li>
<li>使用 PTE_U 标志位为 0 的 PTE；</li>
</ul>
<p>supervisor mode 并不能读写任意物理地址，在 supervisor mode 中，也需要通过 page table 来访问内存，如果一个物理地址映射的虚拟地址并不在当前 SATP 指向的 page table 中，又或者 SATP 指向的 page table 中，PTE_U = 1，那么 supervisor mode 不能使用那个地址。</p>
<h2 id="ecall-指令" class="headerLink">
    <a href="#ecall-%e6%8c%87%e4%bb%a4" class="header-mark" aria-label="Header mark for '&lt;code&gt;ecall&lt;/code&gt; 指令'"></a>2 <code>ecall</code> 指令</h2><p>2020 版的课程以 Xv6 的 <code>sh.c</code> 的 <code>getcmd</code> 中执行的 <code>write</code> 系统调用来说明这个例子（2021 版中，<code>getcmd</code> 转而使用了 <code>fprintf</code>），我这里其实是调试的 <code>echo.c</code>。</p>
<p>执行 <code>make CPUS=1 qemu-gdb</code> 以及 <code>riscv64-unknown-elf-gdb</code>（注意要配置好 <code>.gdbinit</code>），然后 gdb 中执行 <code>file user/echo.o</code> 以及 <code>b main</code>，将断点打在 <code>user/echo.c</code> 的 <code>main</code> 函数处，多执行几次 <code>continue</code>，直到 qemu 中的 shell 加载完成，可以执行命令了，输入 <code>echo zwyyy</code>，再在 <code>gdb</code> 的窗口中执行 <code>layout split</code> 以及 <code>continue</code>，函数将停在 <code>main</code> 函数处，从 <code>echo.asm</code> 中我们可以看到 <code>write</code> 系统调用对应的 ECALL 指令所在的地址，为 $\text{0x31c}$，因此我们执行 <code>b *0x31c</code>，然后执行 <code>continue</code>：</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065846.png"     ></p>
<p>然后我们打印 PC 的值，正好在 $\text{0x31c}$ 处：</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065849.png"     ></p>
<p>a0，a1，a2 寄存器中的内容是 shell 传递给 <code>write</code> 系统调用的参数，a0 是文件描述符，a1 是 shell 想要写入的字符串的指针，a2 是想要写入的字符数：</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065851.png"     ></p>
<p>在 QEMU 中输入 <code>ctrl + a</code>，再输入 <code>c</code> 可以进入到 QEMU 的 console 中，之后输入 <code>info mem</code>，QEMU 会打印完整的 page table</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065852.png"     ></p>
<p>可以看到最后两个 pte 的 vaddr 非常大，接近虚拟地址的顶端，这两个 page 分别是 trapframe page 和 trampoline page。</p>
<p>然后我们输入 <code>stepi</code> 来执行 <code>ecall</code> 指令，此时输入<code>print $pc</code>，发现 pc 中的内容是一个很大的地址，它正是 trampoline page 的最开始，我们的指令正在内存的 trampline page 中。</p>
<p><code>ecall</code> 指令的下一个指令是 <code>csrrw a0, sscratch, a0</code>，交换了寄存器 a0 和寄存器 sscratch 的内容。</p>
<p>我们现在正在 trampoline page 中，ecall 并不会切换 page table，因此，trap 处理代码必须存在于每个 user page table 中，因为 ecall 并不会切换 page table，因此，我们需要在 user page table 中的某处来执行最初的内核代码，而这个 trampoline page 由内核映射到每一个 user page table 中，使得我们仍在使用 user page table 时，内核能在一个地方执行 trap 机制的最开始的一些指令。</p>
<p>这里的指令从 <code>ecall</code> 跳转到 trampoline page 是通过 <code>ecall</code> 指令实现的：</p>
<p>ECALL 指令其实只会做三件事：</p>
<ul>
<li>将代码从 user mode 切换到 supervisor mode；</li>
<li>将 PC 的值保存在 SEPC 寄存器中；</li>
<li>跳转到 STVEC 寄存器指向的指令，STVEC 寄存器只能在 supervisor mode 下进行读写；</li>
</ul>
<p>打印 sepc 寄存器的内容，我们可以看到这个寄存器的内容就是 <code>ecall</code> 指令在用户空间的地址。</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065854.png"   alt="jvAcpDMgtbnmGTq"  ></p>
<h2 id="ecall-指令执行完之后" class="headerLink">
    <a href="#ecall-%e6%8c%87%e4%bb%a4%e6%89%a7%e8%a1%8c%e5%ae%8c%e4%b9%8b%e5%90%8e" class="header-mark" aria-label="Header mark for '&lt;code&gt;ecall&lt;/code&gt; 指令执行完之后'"></a>3 <code>ecall</code> 指令执行完之后</h2><p><code>ecall</code> 帮我们做了开头的工作，但离我们执行内核中的 C 代码还有很多工作要做：</p>
<ul>
<li>我们需要保存 $32$ 个用户寄存器的内容，这样当我们需要恢复执行用户代码时，我们才能恢复这些寄存器的内容，从而让用户代码察觉到不到自己被暂停执行系统调用去了；</li>
<li>从 user page table 切换到 kernel page table</li>
<li>创建或者找到一个 kernel stack，将 stack pointer 寄存器的内容指向那个 kernel stack，这样内核中的 C 代码才有栈可以使用；</li>
<li>还需要跳转到内核中 C 代码某些合理的位置；</li>
</ul>
<p><code>ecall</code> 指令之所以不完成上述的工作，是因为 RISC-V 的设计理念，即“<code>ecall</code> 只尽量完成少的必须要完成的工作，其他工作都交给软件完成，从而为软件与操作系统程序员提供最大的灵活性”。</p>
<h2 id="uservec-函数-与-trampoline-page" class="headerLink">
    <a href="#uservec-%e5%87%bd%e6%95%b0-%e4%b8%8e-trampoline-page" class="header-mark" aria-label="Header mark for '&lt;code&gt;uservec&lt;/code&gt; 函数 与 trampoline page'"></a>4 <code>uservec</code> 函数 与 trampoline page</h2><p>Xv6 为每个 user page table 映射了 trapframe page，在 trapfram page 中有 $32$ 个空槽位，用来保存 $32$ 个用户寄存器的内容。</p>
<p>trapframe page 在 user page table 中的虚拟地址总是 $\text{0x3ffffffe000}$。</p>
<p>如果想要查看 Xv6 在 trapframe page 中存放了什么，可以查看 <code>proc.h</code> 中的 <code>trapframe</code> 结构体。</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065857.png"   alt="FVieGEDny1NXvhp"  ></p>
<p>保存用户寄存器的方案分为两部分：</p>
<ul>
<li>内核将 trapframe page 映射到了每个 user page table；</li>
<li>另一部分则在于 sscratch 寄存器；</li>
</ul>
<p>在进入 user space 之前，内核会将 trapframe page 的地址保存在这个寄存器中，即 $\text{0x3ffffffe000}$。</p>
<p>注意，我们只会<strong>在 user page table 下使用 trapframe page 的虚拟地址</strong>！后面可以看到，在 <code>userret</code> 时，我们是将 kernel page table 切换回 <code>user page table</code> 之后才使用的 <code>trapframe page</code>！</p>
<p>我们可以看到，当执行完 <code>csrrw</code> 指令之后，a0 寄存器中的值就是 trapframe page 的虚拟地址，此后的一系列 <code>sd</code> 指令，就是将寄存器的内容保存在 trapframe page 的不同 offset 处，即 $offset + a0$ 处。</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065858.png"   alt="4a6pAfmx157UTDk"  ></p>
<p>在内核上一次切换回用户空间时，sscratch 寄存器的内容会被设置为 $\text{0x3ffffffe000}$。</p>
<p>Xv6 的启动流程参见 <a href="https://blog.zwyyy456.tech/zh/posts/tech/xv6-os-organization/" target="_blank" rel="noopener noreferrer">MIT 6.S081 操作系统组织架构</a>，会经过一个从 machine mode 到 supervisor mode 再到 user mode 的过程，因此在 <code>ecall</code> 指令执行之前，sscratch 的内容就已经被设置好了。</p>
<p>在第一个 <code>ld</code> 指令之前，有 <code>csrr t0, sscratch</code> 和 <code>sd t0, 112(a0)</code> 这两条指令。这两条指令结合起来，就是将 sscratch 的值写入到了 <code>trapframe</code> 结构体中的 <code>a0</code> 字段处。</p>
<p>然后我们将停在第一个 <code>ld</code> 指令处，这条指令将 a0 中的内存地址（即 trapframe 的地址）往后数 $8$ 个字节处开始的数据加载到 Stack Pointer 寄存器中，由 <code>trapframe</code> 结构体我们可以知道，这里的数据就是内核的 Stack Pointer 的内容。</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065900.png"   alt="j3MWkbvOis7FDeX"  ></p>
<p>trapframe 中的 kernel_sp 是由 kernel 在进入用户空间之前就设置好的，它的值是这个进程的 kernel stack。所以这条指令的作用是初始化 Stack Pointer 指向这个进程的 kernel stack 的最顶端。指向完这条指令之后，我们打印一下当前的 Stack Pointer 寄存器。</p>
<p>下一条指令是将 <code>trapframe</code> 结构体中的 <code>kernel_hartid</code> 写到 tp 寄存器中，<code>kernel_hartid</code> 就是当前 CPU 核的编号。</p>
<p>再下一条指令是往 t0 寄存器中写入数据，这里写入的是将要执行的第一个 C 函数 —— <code>usertrap</code> 的指针。</p>
<p>再下一条指令是向 t1 中写入包含 kernel page table 地址的数据（相比真正的地址，进行了移位）。</p>
<p>再下一条交换 SATP 寄存器和 t1 寄存器，当这条指令完成后，当前程序会从 user page table 切换到 kernel page table，而 t1 寄存器中保存着 user page table 的地址。</p>
<p>我们已经切换了 page table，而程序计数器中保存的是虚拟地址，但我们还是能正确执行内容，同一个虚拟地址不会因为 page table 的切换而走到无关的 pp 中，这正是因为我们还在 trampoline page 中，而 <strong>trampoline page 在用户空间和内核空间都映射到了同一个虚拟地址</strong>。</p>
<p><strong>只有 trampoline page 在 user page table 和 kernel page table 中都映射到了同一个虚拟地址！</strong></p>
<p>最后一条指令是 <code>jr t0</code>，执行了这条指令，我们就从 trampoline page 跳转到内核的 C 代码中去了。</p>
<h2 id="usertrap-函数" class="headerLink">
    <a href="#usertrap-%e5%87%bd%e6%95%b0" class="header-mark" aria-label="Header mark for '&lt;code&gt;usertrap&lt;/code&gt; 函数'"></a>5 <code>usertrap</code> 函数</h2><p><code>usertrap</code> 函数定义于 <code>kernel/trap.c</code> 中：</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065902.png"   alt="5LNSeEWnpHQGP16"  ></p>
<p>首先，我们执行 <code>w_stvec</code>，从而将<code>kernelvec</code> 变量的值写入到  STVEC 中，这是内核空间 trap 处理代码的位置，而不是用户空间 trap 处理代码的位置，从而保证 trap 来源于内核空间时，不会像来源于用户空间时那样执行很多不必要的操作。</p>
<p>然后，我们通过 <code>myproc</code> 函数获取当前进程编号，接下来我们将 SEPC 寄存器中的值保存到 <code>p-&gt;trapframe-&gt;epc</code> 中，防止中途切换到另一个要执行系统调用的进程中导致 SEPC 被覆盖。</p>
<p>接下来我们检查 SCAUSE 寄存器，如果内容为 $8$，说明是通过系统调用触发 trap 的，然后检查是否有其他进程杀掉了当前进程。</p>
<p>我们将 <code>p-&gt;trapframe-&gt;epc += 4</code>，是因为我们希望恢复到用户代码时，不是恢复到 <code>ecall</code> 然后再执行一遍 <code>ecall</code>，而是用户代码中 <code>ecall</code> 的下一条指令，即 <code>ret</code>。</p>
<p>XV6会在处理系统调用的时候使能中断，这样中断可以更快的服务，有些系统调用需要许多时间处理。中断总是会被RISC-V的trap硬件关闭，所以在这个时间点，我们需要执行 <code>intr_on()</code> 显式的打开中断。</p>
<p>之后，我们会调用 <code>syscall</code> 函数，<code>syscall</code> 从 a7 寄存器中获取系统调用编号，而之前系统调用 <code>write</code> 对应的汇编代码中，有一个 <code> li a7, SYS_write</code>，因此 <code>syscall</code> 就知道要去执行 <code>sys_write()</code> 函数了（<code>syscall.c</code> 中定义了一个索引表）。</p>
<p><code>write</code> 的参数在 <code>ecall</code> 之前分别保存在 a0、a1、a2 处，在 trap 机制之后，它们分别位于 <code>trapframe</code> 结构体的 a0、a1、a2 字段处。</p>
<p><code>p-&gt;trapframe-&gt;a0 = syscalls[num]();</code> 这里向 <code>trapframe</code> 中的 a0 赋值是因为：所有系统调用都会返回一个返回值，RISC-V 上的 C 代码习惯将函数返回值存储于寄存器 a0，而返回到用户空间时，trapframe 的 a0 槽位的数值会写回到实际的 a0 寄存器，shell 会认为 a0 寄存器的值就是 <code>write</code> 系统调用的返回值。</p>
<p>在 <code>usertrap</code> 函数中，执行完 <code>syscall</code> 之后，我们再次检查进程是否被杀掉（我们不希望恢复一个被杀掉的进程），然后执行 <code>usertrapret</code>。</p>
<h2 id="usertrapret-函数" class="headerLink">
    <a href="#usertrapret-%e5%87%bd%e6%95%b0" class="header-mark" aria-label="Header mark for '&lt;code&gt;usertrapret&lt;/code&gt; 函数'"></a>6 <code>usertrapret</code> 函数</h2><p>首先，它执行 <code>intr_off</code> 关闭了中断。</p>
<p>然后，执行 <code>w_stvec(TRAMPOLINE + (uservec - trampoline));</code> 将 STVEC 寄存器中的内容修改为指向 user trampoline 的地址。</p>
<p>然后执行一系列操作将对应值填入到 <code>trapframe</code> 中，再之后设置 SSTATUS 寄存器，该寄存器的 SSP bit 为 $0$ 说明我们执行 <code>sret</code> 时应该返回 user mode 而不是 supervisor mode。 SPIE bit 为 $1$ 表明执行 <code>sret</code> 之后是否打开中断。</p>
<p>然后我们将 <code>p-&gt;trapframe-&gt;epc</code> 的值写入到 SEPC 寄存器中去。</p>
<p><code>uint64 fn = TRAMPOLINE + (userret - trampoline)</code> 计算出我们要跳转到的汇编代码的地址，即 trampoline page 中的 <code>userret</code> 函数。</p>
<p>再将相应 user page table 地址写入到 <code>satp</code>，然后通过 <code>fn</code> 函数传递，<strong><code>satp</code> 的值会出现在 a1 寄存器中</strong>，执行该 <code>userret</code> 函数。</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065904.png"   alt="uer61MBGQ8dgtlz"  ></p>
<h2 id="userret-函数" class="headerLink">
    <a href="#userret-%e5%87%bd%e6%95%b0" class="header-mark" aria-label="Header mark for '&lt;code&gt;userret&lt;/code&gt; 函数'"></a>7 <code>userret</code> 函数</h2><p><code>userret</code> 函数位于 <code>trampoline.S</code> 中</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065905.png"   alt="Z5XIy2YRt1ck43i"  ></p>
<p>第一步是将 page table 从 kernel page table 切换到 user page table 中，即<strong>将 a1 寄存器的值写入到 satp 寄存器中去</strong>，<strong>a1 寄存器的值就是 user page table 的地址</strong>。</p>
<p>然后我们执行 <code>ld t0, 112(a0)</code> 和 <code>csrw sscratch, t0</code>，将 <code>p-&gt;trapframe-&gt;a0</code> 的值写入到了 sscratch 寄存器中。</p>
<p>之后是将 <code>trapframe</code> 中的一系列值写回到寄存器中去。</p>
<p><img class="tw-inline" loading="lazy" src="https://pic-upyun.zwyyy456.tech/smms/2023-12-26-065908.png"   alt="KBL6lcbOSnfaq9A"  ></p>
<p>此时 a0 寄存器仍然是 TRAPFRAME 的地址，而 sscratch 寄存器中则是系统调用的返回值，执行一次 <code>csrrw a0, sscratch, a0</code>，交换两个寄存器的值，sscratch 中就存储着 TRAPFRAME 的地址了，而 a0 寄存器中则是系统调用的返回值。</p>
<p><code>sret</code> 是我们在 kernel 中的最后一条指令，执行它会产生以下三个效果：</p>
<ul>
<li>程序切换回 user mode；</li>
<li>SEPC 寄存器的数值被保存到 PC 寄存器，它指向 <code>ecall</code> 的下一条指令 <code>ret</code>；</li>
<li>重新打开中断；</li>
</ul>
</div>

        


<h2>Related Content</h2>
<div class="related-container">
    <div class="related-item-container">
            <h2 class="related-title">
                <a href="/missing-semester-git.zh/">计算机教育缺失的一课：Git</a>
            </h2>
        </div>
    <div class="related-item-container">
            <h2 class="related-title">
                <a href="/missing-semester-command-line.zh/">计算机教育缺失的一课：命令行环境</a>
            </h2>
        </div>
    <div class="related-item-container">
            <h2 class="related-title">
                <a href="/missing-semester-data-organize.zh/">计算机教育缺失的一课：数据整理</a>
            </h2>
        </div>
    <div class="related-item-container">
            <h2 class="related-title">
                <a href="/missing-semester-editor-vim.zh/">计算机教育缺失的一课：编辑器（Vim）</a>
            </h2>
        </div>
    <div class="related-item-container">
            <h2 class="related-title">
                <a href="/xv6-lab11.zh/">Xv6 Lab11: Mmap</a>
            </h2>
        </div>
    

</div>

<div class="sponsor print:tw-hidden">
        <div class="sponsor-avatar"></div><p class="sponsor-bio"><em>If you find this post helpful, please consider sponsoring.</em></p><a href="https://github.com/sponsors/HEIGE-PCloud" title="Sponsor" target="_blank" class="sponsor-button" rel="noopener noreferrer">
                <span style="color: #ec6cb9;"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M458.4 64.3C400.6 15.7 311.3 23 256 79.3 200.7 23 111.4 15.6 53.6 64.3-21.6 127.6-10.6 230.8 43 285.5l175.4 178.7c10 10.2 23.4 15.9 37.6 15.9 14.3 0 27.6-5.6 37.6-15.8L469 285.6c53.5-54.7 64.7-157.9-10.6-221.3zm-23.6 187.5L259.4 430.5c-2.4 2.4-4.4 2.4-6.8 0L77.2 251.8c-36.5-37.2-43.9-107.6 7.3-150.7 38.9-32.7 98.9-27.8 136.5 10.5l35 35.7 35-35.7c37.8-38.5 97.8-43.2 136.5-10.6 51.1 43.1 43.5 113.9 7.3 150.8z"/></svg></span>
                <span>Sponsor</span>
            </a></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-07-08</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line print:!tw-hidden">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/mit6.s081-lec06.zh/index.md target="_blank" rel="noopener noreferrer">Read markdown</a>
                    </span><span>|&nbsp;<a class="link-to-source" href=https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/tech/mit6.s081-lec06.zh.md target="_blank" rel="noopener noreferrer">View source</a>
                    </span><span>|&nbsp;<a class="link-to-edit" href=https://github.com/HEIGE-PCloud/DoIt/edit/main/exampleSite/content/posts/tech/mit6.s081-lec06.zh.md target="_blank" rel="noopener noreferrer">Edit this page</a>
                    </span><span>|&nbsp;<a class="link-to-report" href=https://github.com/HEIGE-PCloud/DoIt/issues/new?title=[bug]%20MIT+6.S081+Isolation+%26+System+call+entry%2Fexit&body=|Field|Value|%0A|-|-|%0A|Title|MIT+6.S081+Isolation+%26+System+call+entry%2Fexit|%0A|Url|http://localhost:1313/mit6.s081-lec06.zh/|%0A|Filename|https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts/tech/mit6.s081-lec06.zh.md| target="_blank" rel="noopener noreferrer">Report issue</a>
                    </span></div>
            <div class="post-info-share"><button title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/mit6.s081-lec06.zh/" data-title="MIT 6.S081 Isolation &amp; System call entry/exit" data-via="xxxx" data-hashtags="xv6,mit,os"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></button><button title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/mit6.s081-lec06.zh/" data-hashtag="xv6"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></button><button title="Share on Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/mit6.s081-lec06.zh/" data-title="MIT 6.S081 Isolation &amp; System call entry/exit"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M0 32v448h448V32H0zm21.2 197.2H21c.1-.1.2-.3.3-.4 0 .1 0 .3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg></button><button title="Share on Line" data-sharer="line" data-url="http://localhost:1313/mit6.s081-lec06.zh/" data-title="MIT 6.S081 Isolation &amp; System call entry/exit"><svg class="icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LINE</title><path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg></button><button title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/mit6.s081-lec06.zh/" data-title="MIT 6.S081 Isolation &amp; System call entry/exit"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></button><button title="Share on Telegram" data-sharer="telegram" data-url="http://localhost:1313/mit6.s081-lec06.zh/" data-title="MIT 6.S081 Isolation &amp; System call entry/exit" data-web><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M446.7 98.6l-67.6 318.8c-5.1 22.5-18.4 28.1-37.3 17.5l-103-75.9-49.7 47.8c-5.5 5.5-10.1 10.1-20.7 10.1l7.4-104.9 190.9-172.5c8.3-7.4-1.8-11.5-12.9-4.1L117.8 284 16.2 252.2c-22.1-6.9-22.5-22.1 4.6-32.7L418.2 66.4c18.4-6.9 34.5 4.1 28.5 32.2z"/></svg></button><script>
        function shareOnMastodon(title, link) {
            const SHARE_MASTODON_DOMAIN = "share_mastodon_domain"
            const savedDomain = localStorage.getItem(SHARE_MASTODON_DOMAIN) ?? "mastodon.social";
            const domain = prompt("Enter your Mastodon domain", savedDomain);
            if (domain === null) {
                return;
            }
            localStorage.setItem(SHARE_MASTODON_DOMAIN, domain)
            const text = title + "\n\n" + link;
            const url = new URL("https://" + domain)
            url.pathname = "share"
            url.searchParams.append('text', text)
            window.open(url, '_blank', "width=500,height=500,left=500,toolbar=0,status=0");
        }
    </script>
    <button title="Share on Mastodon"onclick="javascript:shareOnMastodon(&#34;MIT 6.S081 Isolation \u0026 System call entry/exit&#34;, &#34;http://localhost:1313/mit6.s081-lec06.zh/&#34;)"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg>&nbsp;<a href="/tags/xv6/">Xv6</a>,&nbsp;<a href="/tags/mit/">Mit</a>,&nbsp;<a href="/tags/os/">Os</a></section>
        <section class="print:!tw-hidden">
            <span><button class="tw-text-fgColor-link-muted hover:tw-text-fgColor-link-muted-hover" onclick="window.history.back();">Back</button></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav print:tw-hidden"><a href="/mit6.s081-page-table.zh/" class="prev" rel="prev" title="MIT 6.S081 页表"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6 0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>MIT 6.S081 页表</a>
            <a href="/xv6-lab4.zh/" class="next" rel="next" title="Xv6 Lab4: Traps">Xv6 Lab4: Traps<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.131.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg> DoIt</a>
                </div><div class="footer-line"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532 0-200-89.451-200-200 0-110.531 89.451-200 200-200 110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43 0-140.484-61.425-140.484-141.567 0-79.152 60.275-139.401 139.762-139.401 55.531 0 88.738 26.62 97.593 34.779a11.965 11.965 0 0 1 1.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303 0-77.916 35.33-77.916 80.082 0 41.589 26.888 83.692 78.277 83.692 32.657 0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947 0 0 1-1.152 15.518z"/></svg>2019 - 2024<span class="author">&nbsp;<a href="https://github.com/HEIGE-PCloud" target="_blank" rel="noopener noreferrer">PCloud</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons" class="print:!tw-hidden"><a href="#back-to-top" id="back-to-top-button" class="fixed-button tw-transition-opacity tw-opacity-0" title="Back to Top">
            <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg>
        </a></div><script type="module">
        (async () => {
            const supportSpeculationRules = HTMLScriptElement.supports && HTMLScriptElement.supports("speculationrules");
            if (!supportSpeculationRules) {
              await import("\/lib\/instant.page\/instantpage.min.js");
            }
        })();
    </script>
<script>window.config={"algoliasearch.min.js":"/lib/algoliasearch/algoliasearch-lite.umd.min.js","autocomplete.min.js":"/lib/autocomplete/autocomplete.min.js","comment":{},"search":{"algoliaAppID":"5YGRNRQK1G","algoliaIndex":"en_index","algoliaSearchKey":"0ff6874805de24b84aa1d5ebccad56cd","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":300,"type":"algolia"},"sharerjs":true,"table":{"sort":true}};</script><script
    src="/lib/tablesort/tablesort.min.js"
    
  ></script><script
    src="/lib/sharer/sharer.min.js"
    
  ></script><script
    src="/js/theme.min.js"
    
      defer
    
  ></script>
    
    <script type="speculationrules">
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script>
      
</body>

</html>
